import requests
import pandas as pd
import urllib.parse
import time

API_KEY = "SHlfNEUaJlA7dAAxakVD7js632Mmcibp2ZAttxZA"
EMAIL = "franklee9905@gmail.com"
BASE_URL = "https://developer.nrel.gov/api/nsrdb/v2/solar/nsrdb-GOES-aggregated-v4-0-0-download.json?"
POINTS = [
'520974,520975,520976,520977,520978,520979,520980,520981,520982,520983,520984,520985,520986,520987,520988,520989,520990,520991,520992,520993,520994,520995,520996,520997,520998,520999,521000,521001,521002,521003,521004,521005,521006,522022,522023,522024,522025,522026,522027,522028,522029,522030,522031,522032,522033,522034,522035,522036,522037,522038,522039,522040,522041,522042,522043,522044,522045,522046,522047,522048,522049,522050,522051,522052,522053,522054,523070,523071,523072,523073,523074,523075,523076,523077,523078,523079,523080,523081,523082,523083,523084,523085,523086,523087,523088,523089,523090,523091,523092,523093,523094,523095,523096,523097,523098,523099,523100,523101,523102,524118,524119,524120,524121,524122,524123,524124,524125,524126,524127,524128,524129,524130,524131,524132,524133,524134,524135,524136,524137,524138,524139,524140,524141,524142,524143,524144,524145,524146,524147,524148,524149,524150,525167,525168,525169,525170,525171,525172,525173,525174,525175,525176,525177,525178,525179,525180,525181,525182,525183,525184,525185,525186,525187,525188,525189,525190,525191,525192,525193,525194,525195,525196,525197,525198,525199,526216,526217,526218,526219,526220,526221,526222,526223,526224,526225,526226,526227,526228,526229,526230,526231,526232,526233,526234,526235,526236,526237,526238,526239,526240,526241,526242,526243,526244,526245,526246,526247,526248,527265,527266',
'527267,527268,527269,527270,527271,527272,527273,527274,527275,527276,527277,527278,527279,527280,527281,527282,527283,527284,527285,527286,527287,527288,527289,527290,527291,527292,527293,527294,527295,527296,527297,528314,528315,528316,528317,528318,528319,528320,528321,528322,528323,528324,528325,528326,528327,528328,528329,528330,528331,528332,528333,528334,528335,528336,528337,528338,528339,528340,528341,528342,528343,528344,528345,528346,529364,529365,529366,529367,529368,529369,529370,529371,529372,529373,529374,529375,529376,529377,529378,529379,529380,529381,529382,529383,529384,529385,529386,529387,529388,529389,529390,529391,529392,529393,529394,529395,529396,530414,530415,530416,530417,530418,530419,530420,530421,530422,530423,530424,530425,530426,530427,530428,530429,530430,530431,530432,530433,530434,530435,530436,530437,530438,530439,530440,530441,530442,530443,530444,530445,530446,531464,531465,531466,531467,531468,531469,531470,531471,531472,531473,531474,531475,531476,531477,531478,531479,531480,531481,531482,531483,531484,531485,531486,531487,531488,531489,531490,531491,531492,531493,531494,531495,531496,532514,532515,532516,532517,532518,532519,532520,532521,532522,532523,532524,532525,532526,532527,532528,532529,532530,532531,532532,532533,532534,532535,532536,532537,532538,532539,532540,532541,532542,532543,532544,532545,532546,533565,533566,533567,533568',
'533569,533570,533571,533572,533573,533574,533575,533576,533577,533578,533579,533580,533581,533582,533583,533584,533585,533586,533587,533588,533589,533590,533591,533592,533593,533594,533595,533596,533597,534616,534617,534618,534619,534620,534621,534622,534623,534624,534625,534626,534627,534628,534629,534630,534631,534632,534633,534634,534635,534636,534637,534638,534639,534640,534641,534642,534643,534644,534645,534646,534647,534648,535668,535669,535670,535671,535672,535673,535674,535675,535676,535677,535678,535679,535680,535681,535682,535683,535684,535685,535686,535687,535688,535689,535690,535691,535692,535693,535694,535695,535696,535697,535698,535699,535700,536720,536721,536722,536723,536724,536725,536726,536727,536728,536729,536730,536731,536732,536733,536734,536735,536736,536737,536738,536739,536740,536741,536742,536743,536744,536745,536746,536747,536748,536749,536750,536751,536752,537773,537774,537775,537776,537777,537778,537779,537780,537781,537782,537783,537784,537785,537786,537787,537788,537789,537790,537791,537792,537793,537794,537795,537796,537797,537798,537799,537800,537801,537802,537803,537804,537805,538826,538827,538828,538829,538830,538831,538832,538833,538834,538835,538836,538837,538838,538839,538840,538841,538842,538843,538844,538845,538846,538847,538848,538849,538850,538851,538852,538853,538854,538855,538856,538857,538858,539879,539880,539881,539882,539883,539884',
'539885,539886,539887,539888,539889,539890,539891,539892,539893,539894,539895,539896,539897,539898,539899,539900,539901,539902,539903,539904,539905,539906,539907,539908,539909,539910,539911,540933,540934,540935,540936,540937,540938,540939,540940,540941,540942,540943,540944,540945,540946,540947,540948,540949,540950,540951,540952,540953,540954,540955,540956,540957,540958,540959,540960,540961,540962,540963,540964,540965,541987,541988,541989,541990,541991,541992,541993,541994,541995,541996,541997,541998,541999,542000,542001,542002,542003,542004,542005,542006,542007,542008,542009,542010,542011,542012,542013,542014,542015,542016,542017,542018,542019,543041,543042,543043,543044,543045,543046,543047,543048,543049,543050,543051,543052,543053,543054,543055,543056,543057,543058,543059,543060,543061,543062,543063,543064,543065,543066,543067,543068,543069,543070,543071,543072,543073,544095,544096,544097,544098,544099,544100,544101,544102,544103,544104,544105,544106,544107,544108,544109,544110,544111,544112,544113,544114,544115,544116,544117,544118,544119,544120,544121,544122,544123,544124,544125,544126,544127,545149,545150,545151,545152,545153,545154,545155,545156,545157,545158,545159,545160,545161,545162,545163,545164,545165,545166,545167,545168,545169,545170,545171,545172,545173,545174,545175,545176,545177,545178,545179,545180,545181,546204,546205,546206,546207,546208,546209,546210,546211',
'546212,546213,546214,546215,546216,546217,546218,546219,546220,546221,546222,546223,546224,546225,546226,546227,546228,546229,546230,546231,546232,546233,546234,546235,546236,547259,547260,547261,547262,547263,547264,547265,547266,547267,547268,547269,547270,547271,547272,547273,547274,547275,547276,547277,547278,547279,547280,547281,547282,547283,547284,547285,547286,547287,547288,547289,547290,547291,548314,548315,548316,548317,548318,548319,548320,548321,548322,548323,548324,548325,548326,548327,548328,548329,548330,548331,548332,548333,548334,548335,548336,548337,548338,548339,548340,548341,548342,548343,548344,548345,548346,549369,549370,549371,549372,549373,549374,549375,549376,549377,549378,549379,549380,549381,549382,549383,549384,549385,549386,549387,549388,549389,549390,549391,549392,549393,549394,549395,549396,549397,549398,549399,549400,549401,550425,550426,550427,550428,550429,550430,550431,550432,550433,550434,550435,550436,550437,550438,550439,550440,550441,550442,550443,550444,550445,550446,550447,550448,550449,550450,550451,550452,550453,550454,550455,550456,550457,551481,551482,551483,551484,551485,551486,551487,551488,551489,551490,551491,551492,551493,551494,551495,551496,551497,551498,551499,551500,551501,551502,551503,551504,551505,551506,551507,551508,551509,551510,551511,551512,551513,552537,552538,552539,552540,552541,552542,552543,552544,552545,552546',
'552547,552548,552549,552550,552551,552552,552553,552554,552555,552556,552557,552558,552559,552560,552561,552562,552563,552564,552565,552566,552567,552568,552569,553594,553595,553596,553597,553598,553599,553600,553601,553602,553603,553604,553605,553606,553607,553608,553609,553610,553611,553612,553613,553614,553615,553616,553617,553618,553619,553620,553621,553622,553623,553624,553625,553626,554651,554652,554653,554654,554655,554656,554657,554658,554659,554660,554661,554662,554663,554664,554665,554666,554667,554668,554669,554670,554671,554672,554673,554674,554675,554676,554677,554678,554679,554680,554681,554682,554683,555708,555709,555710,555711,555712,555713,555714,555715,555716,555717,555718,555719,555720,555721,555722,555723,555724,555725,555726,555727,555728,555729,555730,555731,555732,555733,555734,555735,555736,555737,555738,555739,555740,556765,556766,556767,556768,556769,556770,556771,556772,556773,556774,556775,556776,556777,556778,556779,556780,556781,556782,556783,556784,556785,556786,556787,556788,556789,556790,556791,556792,556793,556794,556795,556796,556797,557822,557823,557824,557825,557826,557827,557828,557829,557830,557831,557832,557833,557834,557835,557836,557837,557838,557839,557840,557841,557842,557843,557844,557845,557846,557847,557848,557849,557850,557851,557852,557853,557854,558879,558880,558881,558882,558883,558884,558885,558886,558887,558888,558889,558890',
'558891,558892,558893,558894,558895,558896,558897,558898,558899,558900,558901,558902,558903,558904,558905,558906,558907,558908,558909,558910,558911,559936,559937,559938,559939,559940,559941,559942,559943,559944,559945,559946,559947,559948,559949,559950,559951,559952,559953,559954,559955,559956,559957,559958,559959,559960,559961,559962,559963,559964,559965,559966,559967,559968,560993,560994,560995,560996,560997,560998,560999,561000,561001,561002,561003,561004,561005,561006,561007,561008,561009,561010,561011,561012,561013,561014,561015,561016,561017,561018,561019,561020,561021,561022,561023,561024,561025,562050,562051,562052,562053,562054,562055,562056,562057,562058,562059,562060,562061,562062,562063,562064,562065,562066,562067,562068,562069,562070,562071,562072,562073,562074,562075,562076,562077,562078,562079,562080,562081,562082,563107,563108,563109,563110,563111,563112,563113,563114,563115,563116,563117,563118,563119,563120,563121,563122,563123,563124,563125,563126,563127,563128,563129,563130,563131,563132,563133,563134,563135,563136,563137,563138,563139,564165,564166,564167,564168,564169,564170,564171,564172,564173,564174,564175,564176,564177,564178,564179,564180,564181,564182,564183,564184,564185,564186,564187,564188,564189,564190,564191,564192,564193,564194,564195,564196,564197,565225,565226,565227,565228,565229,565230,565231,565232,565233,565234,565235,565236,565237,565238',
'565239,565240,565241,565242,565243,565244,565245,565246,565247,565248,565249,565250,565251,565252,565253,565254,565255,565256,565257,566286,566287,566288,566289,566290,566291,566292,566293,566294,566295,566296,566297,566298,566299,566300,566301,566302,566303,566304,566305,566306,566307,566308,566309,566310,566311,566312,566313,566314,566315,566316,566317,566318,567348,567349,567350,567351,567352,567353,567354,567355,567356,567357,567358,567359,567360,567361,567362,567363,567364,567365,567366,567367,567368,567369,567370,567371,567372,567373,567374,567375,567376,567377,567378,567379,567380,568411,568412,568413,568414,568415,568416,568417,568418,568419,568420,568421,568422,568423,568424,568425,568426,568427,568428,568429,568430,568431,568432,568433,568434,568435,568436,568437,568438,568439,568440,568441,568442,568443'
]

def main():
    input_data = {
        'attributes': 'alpha,dew_point,ghi,dni,dhi,air_temperature,wind_speed',
        'interval': '60',
        'to_utc': 'false',
        'api_key': API_KEY,
        'email': EMAIL,
    }

    # å¹´ä»½å¾ªçŽ¯
    years = ['2022', '2023'] 

    for name in years:
        print(f"\n=== Processing Year: {name} ===")
        
        for idx, location_ids in enumerate(POINTS):
            input_data['names'] = [name]
            input_data['location_ids'] = location_ids
            print(f'Requesting group {idx + 1}/{len(POINTS)}...')

            # --- è‡ªåŠ¨é‡è¯•æœºåˆ¶ ---
            while True:
                try:
                    headers = {'x-api-key': API_KEY}
                    response = requests.post(BASE_URL, input_data, headers=headers)

                    # æƒ…å†µ A: æˆåŠŸ
                    if response.status_code == 200:
                        data = response.json()
                        download_url = data['outputs']['downloadUrl']
                        print(f"  âœ… [Success] Download URL ready: {download_url}")
                        # ä¿å­˜ URL åˆ°æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
                        with open("download_links.txt", "a") as f:
                            f.write(f"{name} - Group {idx+1}: {download_url}\n")
                        
                        # æˆåŠŸåŽæš‚åœ 2 ç§’ï¼Œé¿å…è¯·æ±‚è¿‡å¯†
                        time.sleep(2)
                        break 
                    
                    # æƒ…å†µ B: è§¦å‘å¹¶å‘é™åˆ¶ (Too many in-flight jobs)
                    elif response.status_code == 400 and "limit" in response.text:
                        print("  â³ [Wait] Server limit reached (20 jobs). Pausing 60s...")
                        time.sleep(60) # ä¹–ä¹–ç­‰å¾… 60 ç§’
                        print("  ðŸ”„ [Retry] Resending request...")
                        continue # é‡æ–°å¾ªçŽ¯ï¼Œå†æ¬¡å‘é€è¯·æ±‚
                    
                    # æƒ…å†µ C: å…¶ä»–é”™è¯¯
                    else:
                        print(f"  âŒ [Error] Status: {response.status_code}")
                        print(f"  Message: {response.text}")
                        break # é‡åˆ°æœªçŸ¥é”™è¯¯ï¼Œè·³è¿‡è¯¥ç»„

                except Exception as e:
                    print(f"  âŒ [Exception] {e}")
                    break

def get_response_json_and_handle_errors(response: requests.Response) -> dict:
    """Takes the given response and handles any errors, along with providing
    the resulting json

    Parameters
    ----------
    response : requests.Response
        The response object

    Returns
    -------
    dict
        The resulting json
    """
    if response.status_code != 200:
        print(f"An error has occurred with the server or the request. The request response code/status: {response.status_code} {response.reason}")
        print(f"The response body: {response.text}")
        exit(1)

    try:
        response_json = response.json()
    except:
        print(f"The response couldn't be parsed as JSON, likely an issue with the server, here is the text: {response.text}")
        exit(1)

    if len(response_json['errors']) > 0:
        errors = '\n'.join(response_json['errors'])
        print(f"The request errored out, here are the errors: {errors}")
        exit(1)
    return response_json

if __name__ == "__main__":
    main()